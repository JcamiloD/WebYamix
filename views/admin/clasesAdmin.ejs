<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('partials/head') %>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>

<body>
    <div class="container-scroller">
        <!-- partial:../../partials/_sidebar.html -->
        <%- include('partials/sidebar') %>
            <!-- partial -->
            <div class="container-fluid page-body-wrapper">
                <!-- partial:../../partials/_navbar.html -->
                <%- include('partials/topbar') %>
                    <!-- partial -->
                    <div class="main-panel">
                        <div class="content-wrapper">
                            <div class="col-lg-12 grid-margin stretch-card">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h3 class="card-title">Clases</h3>
                                            <button class="btn btn-outline-secondary btn-fw" data-toggle="modal" data-target="#addModal">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table id="miTabla" class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>ID Clase</th>
                                                        <th>Curso</th>
                                                        <th>Hora Inicio</th>
                                                        <th>Hora Final</th>
                                                        <th>Instructor</th>
                                                        <th>Estado</th>
                                                        <th>Estudiantes</th>
                                                        <th>Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% if (Array.isArray(data) && data.length > 0) { %>
                                                        <% data.forEach(clase => { %>
                                                            <tr>
                                                                <td><%= clase.id_clase %></td>
                                                                <td><%= clase.nombre_curso %></td>
                                                                <td><%= clase.hora_inicio %></td>
                                                                <td><%= clase.hora_final %></td>
                                                                <td><%= clase.nombre_usuario %></td>
                                                                
                                                                <td><%= clase.estado %></td>
                                                                <td><button class="button-iconn"><i class="fas fa-plus"></i></button></i></td>
                                                                <td>
                                                                    <button type="button" class="button-iconn" data-toggle="modal" data-target="#editModal" 
                                                                            data-id="<%= clase.id_clase %>" data-curso="<%= clase.id_curso %>"
                                                                            data-hora-inicio="<%= clase.hora_inicio %>" data-hora-final="<%= clase.hora_final %>"
                                                                            data-usuario="<%= clase.id_usuario %>" data-estado="<%= clase.estado %>">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button type="button" class="button-iconn" onclick="confirmarEliminacion(<%= clase.id_clase %>)">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        <% }) %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="7">No hay clases disponibles</td>
                                                        </tr>
                                                    <% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    
                            <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="addModalLabel">Agregar Clase</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="addForm">
                                                <div class="form-group">
                                                    <label for="addIdCurso">ID Curso</label>
                                                    <select name="id_curso" class="form-control" id="addIdCurso" required>
                                                        <option value="" disabled selected>Seleccione un curso</option>
                                                        <option value="id_curso"></option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="addHoraInicio">Hora Inicio</label>
                                                    <input type="time" name="hora_inicio" class="form-control" id="addHoraInicio" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="addHoraFinal">Hora Final</label>
                                                    <input type="time" name="hora_final" class="form-control" id="addHoraFinal" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="addIdUsuario">ID Usuario</label>
                                                    <select name="id_usuario" class="form-control" id="addIdUsuario" required>
                                                        <option value="" disabled selected>Seleccione un usuario</option>
                                                        <!-- Aquí se deben agregar las opciones dinámicamente -->
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="addEstado">Estado</label>
                                                    <select name="estado" class="form-control" id="addEstado" required>
                                                        <option value="activo">Activo</option>
                                                        <option value="inactivo">Inactivo</option>
                                                    </select>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-dark mr-2" data-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-dark">Agregar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modal para editar clase -->
                            <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editModalLabel">Editar Clase</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="editForm">
                                                <input type="hidden" name="id_clase" id="editIdClase">
                                                
                                                <div class="form-group">
                                                    <label for="editIdCurso">ID Curso</label>
                                                    <input type="number" name="id_curso" class="form-control" id="editIdCurso" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="editHoraInicio">Hora Inicio</label>
                                                    <input type="time" name="hora_inicio" class="form-control" id="editHoraInicio" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="editHoraFinal">Hora Final</label>
                                                    <input type="time" name="hora_final" class="form-control" id="editHoraFinal" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="editIdUsuario">ID Usuario</label>
                                                    <input type="number" name="id_usuario" class="form-control" id="editIdUsuario" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="editEstado">Estado</label>
                                                    <select name="estado" class="form-control" id="editEstado" required>
                                                        <option value="activo">Activo</option>
                                                        <option value="inactivo">Inactivo</option>
                                                    </select>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-dark mr-2" data-dismiss="modal">Cancelar</button>
                                                    <button type="submit" class="btn btn-dark">Actualizar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- main-panel ends -->
                        </div>
                        <!-- page-body-wrapper ends -->
                        <script>
                            $('#miTabla').on('click', '.button-iconn[data-toggle="modal"]', function() {
                                const idClase = $(this).data('id');
                                const idCurso = $(this).data('curso');
                                const horaInicio = $(this).data('hora-inicio');
                                const horaFinal = $(this).data('hora-final');
                                const idUsuario = $(this).data('usuario');
                                const estado = $(this).data('estado');
                    
                                $('#editIdClase').val(idClase);
                                $('#editIdCurso').val(idCurso);
                                $('#editHoraInicio').val(horaInicio);
                                $('#editHoraFinal').val(horaFinal);
                                $('#editIdUsuario').val(idUsuario);
                                $('#editEstado').val(estado);
                    
                                $('#editModal').modal('show');
                            });
                    
                            $('#editForm').on('submit', function(event) {
                                event.preventDefault();
                    
                                const idClase = $('#editIdClase').val();
                                const formData = {
                                    id_curso: $('#editIdCurso').val(),
                                    hora_inicio: $('#editHoraInicio').val(),
                                    hora_final: $('#editHoraFinal').val(),
                                    id_usuario: $('#editIdUsuario').val(),
                                    estado: $('#editEstado').val()
                                };
                    
                                fetch(`/actualizar_clase/${idClase}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + data.message || 'Error desconocido al actualizar');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error al actualizar la clase:', error);
                                    alert('Error interno del servidor');
                                });
                            });
                    
                            $('#addForm').on('submit', function(event) {
                                event.preventDefault();
                    
                                const formData = {
                                    id_curso: $('#addIdCurso').val(),
                                    hora_inicio: $('#addHoraInicio').val(),
                                    hora_final: $('#addHoraFinal').val(),
                                    id_usuario: $('#addIdUsuario').val(),
                                    estado: $('#addEstado').val()
                                };
                    
                                fetch('/agregar_clase', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(formData)
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        window.location.reload();
                                    } else {
                                        alert('Error: ' + data.message || 'Error desconocido al agregar');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error al agregar la clase:', error);
                                    alert('Error interno del servidor');
                                });
                            });
                    
                            function confirmarEliminacion(id) {
                                if (confirm('¿Estás seguro de que deseas eliminar esta clase?')) {
                                    fetch(`/eliminar_clase/${id}`, {
                                        method: 'DELETE'
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            window.location.reload();
                                        } else {
                                            alert('Error: ' + data.message || 'Error desconocido al eliminar');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error al eliminar la clase:', error);
                                        alert('Error interno del servidor');
                                    });
                                }
                            }
                        </script>
                    </div>
                    
                    
    <!-- container-scroller -->
    <!-- plugins:js -->
    <%- include('partials/scripts') %>


        <!-- End custom js for this page -->
</body>

</html>